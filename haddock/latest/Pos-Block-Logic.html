<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Pos.Block.Logic</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Pos-Block-Logic.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Pos.Block.Logic.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">cryptokami-sl-0.4.4: Cryptokami SL main implementation</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Pos.Block.Logic</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Common/Utils</a></li><li><a href="#g:2">Headers</a></li><li><a href="#g:3">Blocks</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Logic of blocks processing.</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><a href="#v:lcaWithMainChain">lcaWithMainChain</a> :: <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Types-Block-Types.html#t:BlockHeader">BlockHeader</a> ssc) -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)</li><li class="src short"><a href="#v:tipMismatchMsg">tipMismatchMsg</a> :: <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> -&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a></li><li class="src short"><a href="#v:withBlkSemaphore">withBlkSemaphore</a> :: <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; (<a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (a, <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)) -&gt; m a</li><li class="src short"><a href="#v:withBlkSemaphore_">withBlkSemaphore_</a> :: <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; (<a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>) -&gt; m ()</li><li class="src short"><a href="#v:needRecovery">needRecovery</a> :: <span class="keyword">forall</span> ssc m. <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; m <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Bool.html#t:Bool">Bool</a></li><li class="src short"><span class="keyword">data</span> <a href="#t:ClassifyHeaderRes">ClassifyHeaderRes</a><ul class="subs"><li>= <a href="#v:CHContinues">CHContinues</a></li><li>| <a href="#v:CHAlternative">CHAlternative</a></li><li>| <a href="#v:CHUseless">CHUseless</a> !<a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a></li><li>| <a href="#v:CHInvalid">CHInvalid</a> !<a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a></li></ul></li><li class="src short"><a href="#v:classifyNewHeader">classifyNewHeader</a> :: <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="Pos-Types-Block-Types.html#t:BlockHeader">BlockHeader</a> ssc -&gt; m <a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a></li><li class="src short"><span class="keyword">data</span> <a href="#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc<ul class="subs"><li>= <a href="#v:CHsValid">CHsValid</a> (<a href="Pos-Types-Block-Types.html#t:BlockHeader">BlockHeader</a> ssc)</li><li>| <a href="#v:CHsUseless">CHsUseless</a> !<a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a></li><li>| <a href="#v:CHsInvalid">CHsInvalid</a> !<a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a></li></ul></li><li class="src short"><a href="#v:classifyHeaders">classifyHeaders</a> :: <span class="keyword">forall</span> ssc m. <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Types-Block-Types.html#t:BlockHeader">BlockHeader</a> ssc) -&gt; m (<a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc)</li><li class="src short"><a href="#v:getHeadersFromManyTo">getHeadersFromManyTo</a> :: <span class="keyword">forall</span> ssc m. (<a href="http://hackage.haskell.org/package/cryptokami-sl-db-0.4.4/docs/Pos-DB-Class.html#t:MonadDB">MonadDB</a> m, <a href="Pos-Ssc-Class.html#t:SscHelpersClass">SscHelpersClass</a> ssc, <a href="http://hackage.haskell.org/package/log-warper-1.1.2/docs/System-Wlog-CanLog.html#t:CanLog">CanLog</a> m, <a href="http://hackage.haskell.org/package/log-warper-1.1.2/docs/System-Wlog-LoggerNameBox.html#t:HasLoggerName">HasLoggerName</a> m) =&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-List-NonEmpty.html#t:NonEmpty">NonEmpty</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Either.html#t:Either">Either</a> <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> (<a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Types-Block-Types.html#t:BlockHeader">BlockHeader</a> ssc)))</li><li class="src short"><a href="#v:getHeadersOlderExp">getHeadersOlderExp</a> :: <span class="keyword">forall</span> ssc m. (<a href="http://hackage.haskell.org/package/cryptokami-sl-db-0.4.4/docs/Pos-DB-Class.html#t:MonadDB">MonadDB</a> m, <a href="Pos-Ssc-Class.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (<a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> [] <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)</li><li class="src short"><a href="#v:getHeadersFromToIncl">getHeadersFromToIncl</a> :: <span class="keyword">forall</span> ssc m. (<a href="http://hackage.haskell.org/package/cryptokami-sl-db-0.4.4/docs/Pos-DB-Class.html#t:MonadDB">MonadDB</a> m, <a href="Pos-Ssc-Class.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> (<a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>))</li><li class="src short"><a href="#v:verifyAndApplyBlocks">verifyAndApplyBlocks</a> :: (<a href="http://hackage.haskell.org/package/cryptokami-sl-db-0.4.4/docs/Pos-DB-Class.html#t:MonadDBCore">MonadDBCore</a> m, <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m, <a href="Pos-Ssc-Class.html#t:SscWorkersClass">SscWorkersClass</a> ssc) =&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Bool.html#t:Bool">Bool</a> -&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Types-Block-Types.html#t:Block">Block</a> ssc) -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Either.html#t:Either">Either</a> <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)</li><li class="src short"><a href="#v:rollbackBlocks">rollbackBlocks</a> :: <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (Blund ssc) -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a>)</li><li class="src short"><a href="#v:applyWithRollback">applyWithRollback</a> :: (<a href="http://hackage.haskell.org/package/cryptokami-sl-db-0.4.4/docs/Pos-DB-Class.html#t:MonadDBCore">MonadDBCore</a> m, <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m, <a href="Pos-Ssc-Class.html#t:SscWorkersClass">SscWorkersClass</a> ssc) =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (Blund ssc) -&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Types-Block-Types.html#t:Block">Block</a> ssc) -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Either.html#t:Either">Either</a> <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)</li><li class="src short"><a href="#v:createGenesisBlock">createGenesisBlock</a> :: <span class="keyword">forall</span> ssc m. <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:EpochIndex">EpochIndex</a> -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> (<a href="Pos-Types-Block-Types.html#t:GenesisBlock">GenesisBlock</a> ssc))</li><li class="src short"><a href="#v:createMainBlock">createMainBlock</a> :: <span class="keyword">forall</span> ssc m. <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:ProxySKEither">ProxySKEither</a> -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Either.html#t:Either">Either</a> <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> (<a href="Pos-Types-Block-Types.html#t:MainBlock">MainBlock</a> ssc))</li></ul></div><div id="interface"><h1 id="g:1">Common/Utils</h1><div class="top"><p class="src"><a id="v:lcaWithMainChain" class="def">lcaWithMainChain</a> :: <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Types-Block-Types.html#t:BlockHeader">BlockHeader</a> ssc) -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>) <a href="src/Pos.Block.Logic.html#lcaWithMainChain" class="link">Source</a> <a href="#v:lcaWithMainChain" class="selflink">#</a></p><div class="doc"><p>Find LCA of headers list and main chain, including oldest
 header's parent hash. Iterates from newest to oldest until meets
 first header that's in main chain. O(n).</p></div></div><div class="top"><p class="src"><a id="v:tipMismatchMsg" class="def">tipMismatchMsg</a> :: <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> -&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> <a href="src/Pos.Block.Logic.html#tipMismatchMsg" class="link">Source</a> <a href="#v:tipMismatchMsg" class="selflink">#</a></p><div class="doc"><p>Common error message</p></div></div><div class="top"><p class="src"><a id="v:withBlkSemaphore" class="def">withBlkSemaphore</a> :: <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; (<a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (a, <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)) -&gt; m a <a href="src/Pos.Block.Logic.Internal.html#withBlkSemaphore" class="link">Source</a> <a href="#v:withBlkSemaphore" class="selflink">#</a></p><div class="doc"><p>Run action acquiring lock on block application. Argument of
 action is an old tip, result is put as a new tip.</p></div></div><div class="top"><p class="src"><a id="v:withBlkSemaphore_" class="def">withBlkSemaphore_</a> :: <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; (<a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>) -&gt; m () <a href="src/Pos.Block.Logic.Internal.html#withBlkSemaphore_" class="link">Source</a> <a href="#v:withBlkSemaphore_" class="selflink">#</a></p><div class="doc"><p>Version of withBlkSemaphore which doesn't have any result.</p></div></div><div class="top"><p class="src"><a id="v:needRecovery" class="def">needRecovery</a> :: <span class="keyword">forall</span> ssc m. <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; m <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Bool.html#t:Bool">Bool</a> <a href="src/Pos.Block.Logic.html#needRecovery" class="link">Source</a> <a href="#v:needRecovery" class="selflink">#</a></p><div class="doc"><p>The phrase &#8220;we're in recovery mode&#8221; is confusing because it can mean two
 different things:</p><ol><li>Last known block is more than K slots away from the current slot, or
    current slot isn't known.</li><li>We're actually in the process of requesting blocks because we have
    detected that #1 happened. (See <code>ncRecoveryHeader</code> and
    <code>recoveryInProgress</code>.)</li></ol><p>This function checks for #1. Note that even if we're doing recovery right
 now, <code><a href="Pos-Block-Logic.html#v:needRecovery">needRecovery</a></code> will still return <code><a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Bool.html#v:True">True</a></code>.</p></div></div><h1 id="g:2">Headers</h1><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ClassifyHeaderRes" class="def">ClassifyHeaderRes</a> <a href="src/Pos.Block.Logic.html#ClassifyHeaderRes" class="link">Source</a> <a href="#t:ClassifyHeaderRes" class="selflink">#</a></p><div class="doc"><p>Result of single (new) header classification.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:CHContinues" class="def">CHContinues</a></td><td class="doc"><p>Header is direct continuation of main chain (i.e. its
 parent is our tip).</p></td></tr><tr><td class="src"><a id="v:CHAlternative" class="def">CHAlternative</a></td><td class="doc"><p>Header continues main or alternative chain, it's more
 difficult than tip.</p></td></tr><tr><td class="src"><a id="v:CHUseless" class="def">CHUseless</a> !<a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a></td><td class="doc"><p>Header is useless.</p></td></tr><tr><td class="src"><a id="v:CHInvalid" class="def">CHInvalid</a> !<a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a></td><td class="doc"><p>Header is invalid.</p></td></tr></table></div><div class="subs instances"><p id="control.i:ClassifyHeaderRes" class="caption collapser" onclick="toggleSection('i:ClassifyHeaderRes')">Instances</p><div id="section.i:ClassifyHeaderRes" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><span id="control.i:id:ClassifyHeaderRes:Show:1" class="instance expander" onclick="toggleSection('i:id:ClassifyHeaderRes:Show:1')"></span> <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Text-Show.html#t:Show">Show</a> <a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a></span> <a href="src/Pos.Block.Logic.html#line-185" class="link">Source</a> <a href="#t:ClassifyHeaderRes" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div id="section.i:id:ClassifyHeaderRes:Show:1" class="inst-details hide"><div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> :: <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Int.html#t:Int">Int</a> -&gt; <a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a> -&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Text-Show.html#t:ShowS">ShowS</a> <a href="#v:showsPrec" class="selflink">#</a></p><p class="src"><a href="#v:show">show</a> :: <a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a> -&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-String.html#t:String">String</a> <a href="#v:show" class="selflink">#</a></p><p class="src"><a href="#v:showList">showList</a> :: [<a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a>] -&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Text-Show.html#t:ShowS">ShowS</a> <a href="#v:showList" class="selflink">#</a></p></div></div></td></tr></table></div></div></div><div class="top"><p class="src"><a id="v:classifyNewHeader" class="def">classifyNewHeader</a> :: <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="Pos-Types-Block-Types.html#t:BlockHeader">BlockHeader</a> ssc -&gt; m <a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a> <a href="src/Pos.Block.Logic.html#classifyNewHeader" class="link">Source</a> <a href="#v:classifyNewHeader" class="selflink">#</a></p><div class="doc"><p>Classify new header announced by some node. Result is represented
 as ClassifyHeaderRes type.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ClassifyHeadersRes" class="def">ClassifyHeadersRes</a> ssc <a href="src/Pos.Block.Logic.html#ClassifyHeadersRes" class="link">Source</a> <a href="#t:ClassifyHeadersRes" class="selflink">#</a></p><div class="doc"><p>Result of multiple headers classification.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:CHsValid" class="def">CHsValid</a> (<a href="Pos-Types-Block-Types.html#t:BlockHeader">BlockHeader</a> ssc)</td><td class="doc"><p>Header list can be applied,
    LCA child attached.</p></td></tr><tr><td class="src"><a id="v:CHsUseless" class="def">CHsUseless</a> !<a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a></td><td class="doc"><p>Header is useless.</p></td></tr><tr><td class="src"><a id="v:CHsInvalid" class="def">CHsInvalid</a> !<a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a></td><td class="doc"><p>Header is invalid.</p></td></tr></table></div><div class="subs instances"><p id="control.i:ClassifyHeadersRes" class="caption collapser" onclick="toggleSection('i:ClassifyHeadersRes')">Instances</p><div id="section.i:ClassifyHeadersRes" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><span id="control.i:id:ClassifyHeadersRes:Show:1" class="instance expander" onclick="toggleSection('i:id:ClassifyHeadersRes:Show:1')"></span> <a href="Pos-Ssc-Class.html#t:Ssc">Ssc</a> ssc =&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Text-Show.html#t:Show">Show</a> (<a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc)</span> <a href="src/Pos.Block.Logic.html#line-248" class="link">Source</a> <a href="#t:ClassifyHeadersRes" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div id="section.i:id:ClassifyHeadersRes:Show:1" class="inst-details hide"><div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> :: <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Int.html#t:Int">Int</a> -&gt; <a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc -&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Text-Show.html#t:ShowS">ShowS</a> <a href="#v:showsPrec" class="selflink">#</a></p><p class="src"><a href="#v:show">show</a> :: <a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc -&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-String.html#t:String">String</a> <a href="#v:show" class="selflink">#</a></p><p class="src"><a href="#v:showList">showList</a> :: [<a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc] -&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Text-Show.html#t:ShowS">ShowS</a> <a href="#v:showList" class="selflink">#</a></p></div></div></td></tr></table></div></div></div><div class="top"><p class="src"><a id="v:classifyHeaders" class="def">classifyHeaders</a> :: <span class="keyword">forall</span> ssc m. <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Types-Block-Types.html#t:BlockHeader">BlockHeader</a> ssc) -&gt; m (<a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc) <a href="src/Pos.Block.Logic.html#classifyHeaders" class="link">Source</a> <a href="#v:classifyHeaders" class="selflink">#</a></p><div class="doc"><p>Classify headers received in response to <code>GetHeaders</code> message.</p><ul><li>If there are any errors in chain of headers, CHsInvalid is returned.</li><li>If chain of headers is a valid continuation or alternative branch,
    lca child is returned.</li><li>If chain of headers forks from our main chain too much, CHsUseless
    is returned, because paper suggests doing so.</li><li>CHsUseless is also returned if we aren't too far behind the current slot
    (i.e. if <code><a href="Pos-Block-Logic.html#v:needRecovery">needRecovery</a></code> is false) but the newest header in the list isn't
    from the current slot. See CSL-177.</li></ul></div></div><div class="top"><p class="src"><a id="v:getHeadersFromManyTo" class="def">getHeadersFromManyTo</a> <a href="src/Pos.Block.Logic.html#getHeadersFromManyTo" class="link">Source</a> <a href="#v:getHeadersFromManyTo" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (<a href="http://hackage.haskell.org/package/cryptokami-sl-db-0.4.4/docs/Pos-DB-Class.html#t:MonadDB">MonadDB</a> m, <a href="Pos-Ssc-Class.html#t:SscHelpersClass">SscHelpersClass</a> ssc, <a href="http://hackage.haskell.org/package/log-warper-1.1.2/docs/System-Wlog-CanLog.html#t:CanLog">CanLog</a> m, <a href="http://hackage.haskell.org/package/log-warper-1.1.2/docs/System-Wlog-LoggerNameBox.html#t:HasLoggerName">HasLoggerName</a> m)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-List-NonEmpty.html#t:NonEmpty">NonEmpty</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a></td><td class="doc"><p>Checkpoints; not guaranteed to be
   in any particular order</p></td></tr><tr><td class="src">-&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Either.html#t:Either">Either</a> <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> (<a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Types-Block-Types.html#t:BlockHeader">BlockHeader</a> ssc)))</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Given a set of checkpoints <code>c</code> to stop at and a terminating
 header hash <code>h</code>, we take <code>h</code> block (or tip if latter is <code>Nothing</code>)
 and fetch the blocks until one of checkpoints is encountered. In
 case we got deeper than <code><a href="Pos-Constants.html#v:recoveryHeadersMessage">recoveryHeadersMessage</a></code>, we return
 <code><a href="Pos-Constants.html#v:recoveryHeadersMessage">recoveryHeadersMessage</a></code> headers starting from the the newest
 checkpoint that's in our main chain to the newest ones.</p></div></div><div class="top"><p class="src"><a id="v:getHeadersOlderExp" class="def">getHeadersOlderExp</a> :: <span class="keyword">forall</span> ssc m. (<a href="http://hackage.haskell.org/package/cryptokami-sl-db-0.4.4/docs/Pos-DB-Class.html#t:MonadDB">MonadDB</a> m, <a href="Pos-Ssc-Class.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (<a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> [] <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>) <a href="src/Pos.Block.Logic.html#getHeadersOlderExp" class="link">Source</a> <a href="#v:getHeadersOlderExp" class="selflink">#</a></p><div class="doc"><p>Given a starting point hash (we take tip if it's not in storage)
 it returns not more than <code><a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Constants.html#v:blkSecurityParam">blkSecurityParam</a></code> blocks distributed
 exponentially base 2 relatively to the depth in the blockchain.</p></div></div><div class="top"><p class="src"><a id="v:getHeadersFromToIncl" class="def">getHeadersFromToIncl</a> :: <span class="keyword">forall</span> ssc m. (<a href="http://hackage.haskell.org/package/cryptokami-sl-db-0.4.4/docs/Pos-DB-Class.html#t:MonadDB">MonadDB</a> m, <a href="Pos-Ssc-Class.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> (<a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)) <a href="src/Pos.Block.Logic.html#getHeadersFromToIncl" class="link">Source</a> <a href="#v:getHeadersFromToIncl" class="selflink">#</a></p><div class="doc"><p>Given <code>from</code> and <code>to</code> headers where <code>from</code> is older (not strict)
 than <code>to</code>, and valid chain in between can be found, headers in
 range <code>[from..to]</code> will be found.</p></div></div><h1 id="g:3">Blocks</h1><div class="top"><p class="src"><a id="v:verifyAndApplyBlocks" class="def">verifyAndApplyBlocks</a> :: (<a href="http://hackage.haskell.org/package/cryptokami-sl-db-0.4.4/docs/Pos-DB-Class.html#t:MonadDBCore">MonadDBCore</a> m, <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m, <a href="Pos-Ssc-Class.html#t:SscWorkersClass">SscWorkersClass</a> ssc) =&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Bool.html#t:Bool">Bool</a> -&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Types-Block-Types.html#t:Block">Block</a> ssc) -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Either.html#t:Either">Either</a> <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>) <a href="src/Pos.Block.Logic.html#verifyAndApplyBlocks" class="link">Source</a> <a href="#v:verifyAndApplyBlocks" class="selflink">#</a></p><div class="doc"><p>Applies blocks if they're valid. Takes one boolean flag
 &quot;rollback&quot;. Returns header hash of last applied block (new tip) on
 success. Failure behaviour depends on &quot;rollback&quot; flag. If it's on,
 all blocks applied inside this function will be rollbacked, so it
 will do effectively nothing and return 'Left error'. If it's off,
 it will try to apply as much blocks as it's possible and return
 header hash of new tip. It's up to caller to log warning that
 partial application happened.</p></div></div><div class="top"><p class="src"><a id="v:rollbackBlocks" class="def">rollbackBlocks</a> :: <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (Blund ssc) -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a>) <a href="src/Pos.Block.Logic.html#rollbackBlocks" class="link">Source</a> <a href="#v:rollbackBlocks" class="selflink">#</a></p><div class="doc"><p>Rollbacks blocks. Head must be the current tip.</p></div></div><div class="top"><p class="src"><a id="v:applyWithRollback" class="def">applyWithRollback</a> <a href="src/Pos.Block.Logic.html#applyWithRollback" class="link">Source</a> <a href="#v:applyWithRollback" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (<a href="http://hackage.haskell.org/package/cryptokami-sl-db-0.4.4/docs/Pos-DB-Class.html#t:MonadDBCore">MonadDBCore</a> m, <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m, <a href="Pos-Ssc-Class.html#t:SscWorkersClass">SscWorkersClass</a> ssc)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (Blund ssc)</td><td class="doc"><p>Blocks to rollbck</p></td></tr><tr><td class="src">-&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Types-Block-Types.html#t:Block">Block</a> ssc)</td><td class="doc"><p>Blocks to apply</p></td></tr><tr><td class="src">-&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Either.html#t:Either">Either</a> <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Rollbacks some blocks and then applies some blocks.</p></div></div><div class="top"><p class="src"><a id="v:createGenesisBlock" class="def">createGenesisBlock</a> :: <span class="keyword">forall</span> ssc m. <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:EpochIndex">EpochIndex</a> -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> (<a href="Pos-Types-Block-Types.html#t:GenesisBlock">GenesisBlock</a> ssc)) <a href="src/Pos.Block.Logic.html#createGenesisBlock" class="link">Source</a> <a href="#v:createGenesisBlock" class="selflink">#</a></p><div class="doc"><p>Create genesis block if necessary.</p><p>We create genesis block for current epoch when head of currently
 known best chain is MainBlock corresponding to one of last
 <code><a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Constants.html#v:slotSecurityParam">slotSecurityParam</a></code> slots of (i - 1)-th epoch. Main check is that
 epoch is `(last stored epoch + 1)`, but we also don't want to
 create genesis block on top of blocks from previous epoch which are
 not from last slotSecurityParam slots, because it's practically
 impossible for them to be valid.
 [CSL-481] We can do consider doing it though.</p></div></div><div class="top"><p class="src"><a id="v:createMainBlock" class="def">createMainBlock</a> :: <span class="keyword">forall</span> ssc m. <a href="Pos-WorkMode.html#t:WorkMode">WorkMode</a> ssc m =&gt; <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Types.html#t:ProxySKEither">ProxySKEither</a> -&gt; m (<a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Either.html#t:Either">Either</a> <a href="http://hackage.haskell.org/package/text-1.2.2.1/docs/Data-Text.html#t:Text">Text</a> (<a href="Pos-Types-Block-Types.html#t:MainBlock">MainBlock</a> ssc)) <a href="src/Pos.Block.Logic.html#createMainBlock" class="link">Source</a> <a href="#v:createMainBlock" class="selflink">#</a></p><div class="doc"><p>Create a new main block on top of best chain if possible.
 Block can be created if:
 &#8226; we know genesis block for epoch from given SlotId
 &#8226; last known block is not more than <code><a href="http://hackage.haskell.org/package/cryptokami-sl-core-0.4.4/docs/Pos-Core-Constants.html#v:slotSecurityParam">slotSecurityParam</a></code> blocks away from
 given SlotId</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.17.3</p></div></body></html>