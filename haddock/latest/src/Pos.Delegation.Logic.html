<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell     #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- | All logic of certificates processing</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span><span class="hs-operator">.</span><span class="hs-identifier">Logic</span><span>
</span><a name="line-8"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-9"></a><span>       </span><span class="hs-comment">-- * Helpers</span><span>
</span><a name="line-10"></a><span>         </span><a href="Pos.Delegation.Logic.html#DelegationStateAction"><span class="hs-identifier hs-type">DelegationStateAction</span></a><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#runDelegationStateAction"><span class="hs-identifier hs-var">runDelegationStateAction</span></a><span>
</span><a name="line-12"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#invalidateProxyCaches"><span class="hs-identifier hs-var">invalidateProxyCaches</span></a><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span>       </span><span class="hs-comment">-- * Initialization</span><span>
</span><a name="line-15"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#initDelegation"><span class="hs-identifier hs-var">initDelegation</span></a><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>       </span><span class="hs-comment">-- * Heavyweight psks handling</span><span>
</span><a name="line-18"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#getProxyMempool"><span class="hs-identifier hs-var">getProxyMempool</span></a><span>
</span><a name="line-19"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#clearProxyMemPool"><span class="hs-identifier hs-var">clearProxyMemPool</span></a><span>
</span><a name="line-20"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#PskHeavyVerdict"><span class="hs-identifier hs-type">PskHeavyVerdict</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#processProxySKHeavy"><span class="hs-identifier hs-var">processProxySKHeavy</span></a><span>
</span><a name="line-22"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#delegationApplyBlocks"><span class="hs-identifier hs-var">delegationApplyBlocks</span></a><span>
</span><a name="line-23"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#delegationVerifyBlocks"><span class="hs-identifier hs-var">delegationVerifyBlocks</span></a><span>
</span><a name="line-24"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#delegationRollbackBlocks"><span class="hs-identifier hs-var">delegationRollbackBlocks</span></a><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span>       </span><span class="hs-comment">-- * Lightweight psks handling</span><span>
</span><a name="line-27"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#PskLightVerdict"><span class="hs-identifier hs-type">PskLightVerdict</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#processProxySKLight"><span class="hs-identifier hs-var">processProxySKLight</span></a><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>       </span><span class="hs-comment">-- * Confirmations</span><span>
</span><a name="line-31"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#ConfirmPskLightVerdict"><span class="hs-identifier hs-type">ConfirmPskLightVerdict</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#processConfirmProxySk"><span class="hs-identifier hs-var">processConfirmProxySk</span></a><span>
</span><a name="line-33"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.html#isProxySKConfirmed"><span class="hs-identifier hs-var">isProxySKConfirmed</span></a><span>
</span><a name="line-34"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">makeLenses</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">uses</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">_Wrapped</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Ether</span><span class="hs-operator">.</span><span class="hs-identifier">Implicit</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Ether</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">Except</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">runExceptT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throwE</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashMap</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HM</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashSet</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HS</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">partition</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Buildable</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">UTCTime</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">addUTCTime</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bprint</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">build</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stext</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WithLogger</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Binary.Communication.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Communication</span></a><span>     </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>              </span><span class="hs-special">(</span><a href="Pos.Block.Types.html#Blund"><span class="hs-identifier hs-type">Blund</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Block.Types.html#Undo"><span class="hs-identifier hs-type">Undo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">undoPsk</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Constants.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Constants</span></a><span>                </span><span class="hs-special">(</span><a href="Pos.Constants.html#lightDlgConfirmationTimeout"><span class="hs-identifier hs-var">lightDlgConfirmationTimeout</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>                                               </span><a href="Pos.Constants.html#messageCacheTimeout"><span class="hs-identifier hs-var">messageCacheTimeout</span></a><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Context.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span></a><span>                  </span><span class="hs-special">(</span><a href="Pos.Context.Class.html#WithNodeContext"><span class="hs-identifier hs-type">WithNodeContext</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Context.Class.html#getNodeContext"><span class="hs-identifier hs-var">getNodeContext</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>                                               </span><a href="Pos.Context.Functions.html#lrcActionOnEpochReason"><span class="hs-identifier hs-var">lrcActionOnEpochReason</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Context.Context.html#ncNodeParams"><span class="hs-identifier hs-var">ncNodeParams</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>                                               </span><a href="Pos.Launcher.Param.html#npSecretKey"><span class="hs-identifier hs-var">npSecretKey</span></a><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ProxySecretKey</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PublicKey</span><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>                                               </span><span class="hs-identifier hs-type">SignTag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SignProxySK</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pdDelegatePk</span><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>                                               </span><span class="hs-identifier hs-var">proxyVerify</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">shortHashF</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toPublic</span><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>                                               </span><span class="hs-identifier hs-var">verifyProxySecretKey</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DBError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DBMalformed</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadDB</span><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>                                               </span><span class="hs-identifier hs-type">SomeBatchOp</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DB</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.DB.Block.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span></a><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DB</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.DB.DB.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DB</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.DB.GState.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">GState</span></a><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GS</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.DB.Misc.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">Misc</span></a><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Misc</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Delegation.Class.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Delegation.Class.html#DelegationWrap"><span class="hs-identifier hs-type">DelegationWrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#MonadDelegation"><span class="hs-identifier hs-type">MonadDelegation</span></a><span class="hs-special">,</span><span>
</span><a name="line-68"></a><span>                                               </span><a href="Pos.Delegation.Class.html#askDelegationState"><span class="hs-identifier hs-var">askDelegationState</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#dwConfirmationCache"><span class="hs-identifier hs-var">dwConfirmationCache</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>                                               </span><a href="Pos.Delegation.Class.html#dwEpochId"><span class="hs-identifier hs-var">dwEpochId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#dwMessageCache"><span class="hs-identifier hs-var">dwMessageCache</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#dwProxySKPool"><span class="hs-identifier hs-var">dwProxySKPool</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>                                               </span><a href="Pos.Delegation.Class.html#dwThisEpochPosted"><span class="hs-identifier hs-var">dwThisEpochPosted</span></a><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Delegation.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Delegation.Types.html#SendProxySK"><span class="hs-identifier hs-type">SendProxySK</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cryptokamiExceptionFromException</span><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>                                               </span><span class="hs-identifier hs-var">cryptokamiExceptionToException</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Lrc</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LrcContext</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.Lrc.DB.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Lrc</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LrcDB</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Ssc.Class.Helpers.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Helpers</span></a><span>        </span><span class="hs-special">(</span><a href="Pos.Ssc.Class.Helpers.html#SscHelpersClass"><span class="hs-identifier hs-type">SscHelpersClass</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>                    </span><span class="hs-special">(</span><a href="Pos.Types.Block.Types.html#Block"><span class="hs-identifier hs-type">Block</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HeaderHash</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ProxySKHeavy</span><span class="hs-special">,</span><span>
</span><a name="line-78"></a><span>                                               </span><span class="hs-identifier hs-type">ProxySKLight</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ProxySigLight</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">addressHash</span><span class="hs-special">,</span><span>
</span><a name="line-79"></a><span>                                               </span><a href="Pos.Types.Block.Instances.html#blockProxySKs"><span class="hs-identifier hs-var">blockProxySKs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">epochIndexL</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">headerHash</span><span class="hs-special">,</span><span>
</span><a name="line-80"></a><span>                                               </span><span class="hs-identifier hs-var">prevBlockL</span><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>                     </span><span class="hs-special">(</span><a href="Pos.Util.html#withReadLifted"><span class="hs-identifier hs-var">withReadLifted</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#withWriteLifted"><span class="hs-identifier hs-var">withWriteLifted</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#_neHead"><span class="hs-identifier hs-var">_neHead</span></a><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>                                               </span><a href="Pos.Util.html#_neLast"><span class="hs-identifier hs-var">_neLast</span></a><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Chrono</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NE</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NewestFirst</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OldestFirst</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasContext</span><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ether</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- Different helpers to simplify logic</span><span>
</span><a name="line-89"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-comment">-- | Convenient monad to work in 'DelegationWrap' context while being</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- in STM.</span><span>
</span><a name="line-93"></a><span class="hs-keyword">type</span><span> </span><a name="DelegationStateAction"><a href="Pos.Delegation.Logic.html#DelegationStateAction"><span class="hs-identifier">DelegationStateAction</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Ether</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">StateT</span><span> </span><a href="Pos.Delegation.Class.html#DelegationWrap"><span class="hs-identifier hs-type">DelegationWrap</span></a><span> </span><span class="hs-identifier hs-type">STM</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-comment">-- | Effectively takes a lock on ProxyCaches mvar in NodeContext and</span><span>
</span><a name="line-96"></a><span class="hs-comment">-- allows you to run some computation producing updated ProxyCaches</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- and return value. Will put MVar back on exception.</span><span>
</span><a name="line-98"></a><span class="hs-identifier">runDelegationStateAction</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621680330668"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#MonadDelegation"><span class="hs-identifier hs-type">MonadDelegation</span></a><span> </span><a href="#local-6989586621680330668"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Pos.Delegation.Logic.html#DelegationStateAction"><span class="hs-identifier hs-type">DelegationStateAction</span></a><span> </span><a href="#local-6989586621680330669"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680330668"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621680330669"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-101"></a><a name="runDelegationStateAction"><a href="Pos.Delegation.Logic.html#runDelegationStateAction"><span class="hs-identifier">runDelegationStateAction</span></a></a><span> </span><a name="local-6989586621680330670"><a href="#local-6989586621680330670"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-102"></a><span>    </span><a name="local-6989586621680330671"><a href="#local-6989586621680330671"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Delegation.Class.html#askDelegationState"><span class="hs-identifier hs-var">askDelegationState</span></a><span>
</span><a name="line-103"></a><span>    </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-104"></a><span>        </span><a name="local-6989586621680330672"><a href="#local-6989586621680330672"><span class="hs-identifier">startState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readTVar</span><span> </span><a href="#local-6989586621680330671"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-105"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621680330673"><a href="#local-6989586621680330673"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680330674"><a href="#local-6989586621680330674"><span class="hs-identifier">newState</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Ether</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">runStateT</span><span> </span><a href="#local-6989586621680330670"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621680330672"><span class="hs-identifier hs-var">startState</span></a><span>
</span><a name="line-106"></a><span>        </span><span class="hs-identifier hs-var">writeTVar</span><span> </span><a href="#local-6989586621680330671"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680330674"><span class="hs-identifier hs-var">newState</span></a><span>
</span><a name="line-107"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621680330673"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-comment">-- | Invalidates proxy caches using built-in constants.</span><span>
</span><a name="line-110"></a><span class="hs-identifier">invalidateProxyCaches</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.html#DelegationStateAction"><span class="hs-identifier hs-type">DelegationStateAction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><a name="invalidateProxyCaches"><a href="Pos.Delegation.Logic.html#invalidateProxyCaches"><span class="hs-identifier">invalidateProxyCaches</span></a></a><span> </span><a name="local-6989586621680330675"><a href="#local-6989586621680330675"><span class="hs-identifier">curTime</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ether</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-112"></a><span>    </span><a href="Pos.Delegation.Class.html#dwMessageCache"><span class="hs-identifier hs-var">dwMessageCache</span></a><span> </span><span class="hs-operator hs-var">%=</span><span>
</span><a name="line-113"></a><span>        </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680330678"><a href="#local-6989586621680330678"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">addUTCTime</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680330676"><span class="hs-identifier hs-var">toDiffTime</span></a><span> </span><a href="Pos.Constants.html#messageCacheTimeout"><span class="hs-identifier hs-var">messageCacheTimeout</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680330678"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621680330675"><span class="hs-identifier hs-var">curTime</span></a><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>    </span><a href="Pos.Delegation.Class.html#dwConfirmationCache"><span class="hs-identifier hs-var">dwConfirmationCache</span></a><span> </span><span class="hs-operator hs-var">%=</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680330679"><a href="#local-6989586621680330679"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">addUTCTime</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680330676"><span class="hs-identifier hs-var">toDiffTime</span></a><span> </span><a href="Pos.Constants.html#lightDlgConfirmationTimeout"><span class="hs-identifier hs-var">lightDlgConfirmationTimeout</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680330679"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621680330675"><span class="hs-identifier hs-var">curTime</span></a><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-117"></a><span>    </span><a name="local-6989586621680330676"><a href="#local-6989586621680330676"><span class="hs-identifier">toDiffTime</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680330677"><a href="#local-6989586621680330677"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621680330677"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-keyword">type</span><span> </span><a name="DelegationWorkMode"><a href="Pos.Delegation.Logic.html#DelegationWorkMode"><span class="hs-identifier">DelegationWorkMode</span></a></a><span> </span><a name="local-6989586621680330659"><a href="#local-6989586621680330659"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Class.html#MonadDelegation"><span class="hs-identifier hs-type">MonadDelegation</span></a><span> </span><a href="#local-6989586621680330659"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadDB</span><span> </span><a href="#local-6989586621680330659"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WithLogger</span><span> </span><a href="#local-6989586621680330659"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-comment">-- Retrieves psk certificated that have been accumulated before given</span><span>
</span><a name="line-122"></a><span class="hs-comment">-- block. The block itself should be in DB.</span><span>
</span><a name="line-123"></a><span class="hs-identifier">getPSKsFromThisEpoch</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621680330666"><a href="#local-6989586621680330666"><span class="hs-identifier">ssc</span></a></a><span> </span><a name="local-6989586621680330667"><a href="#local-6989586621680330667"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-125"></a><span>       </span><span class="hs-special">(</span><a href="Pos.Ssc.Class.Helpers.html#SscHelpersClass"><span class="hs-identifier hs-type">SscHelpersClass</span></a><span> </span><a href="#local-6989586621680330666"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadDB</span><span> </span><a href="#local-6989586621680330667"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HeaderHash</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680330667"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ProxySKHeavy</span><span class="hs-special">]</span><span>
</span><a name="line-127"></a><a name="getPSKsFromThisEpoch"><a href="Pos.Delegation.Logic.html#getPSKsFromThisEpoch"><span class="hs-identifier">getPSKsFromThisEpoch</span></a></a><span> </span><a name="local-6989586621680330680"><a href="#local-6989586621680330680"><span class="hs-identifier">tip</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">view</span><span> </span><a href="Pos.Types.Block.Instances.html#blockProxySKs"><span class="hs-identifier hs-var">blockProxySKs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-special">(</span><a href="Pos.DB.Block.html#loadBlocksWhile"><span class="hs-identifier hs-var">DB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">loadBlocksWhile</span></a><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621680330666"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">isRight</span><span> </span><a href="#local-6989586621680330680"><span class="hs-identifier hs-var">tip</span></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-132"></a><span class="hs-comment">-- Exceptions</span><span>
</span><a name="line-133"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-keyword">data</span><span> </span><a name="DelegationError"><a href="Pos.Delegation.Logic.html#DelegationError"><span class="hs-identifier">DelegationError</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-comment">-- | Can't apply blocks to state of transactions processing.</span><span>
</span><a name="line-137"></a><span>    </span><a name="DelegationCantApplyBlocks"><a href="Pos.Delegation.Logic.html#DelegationCantApplyBlocks"><span class="hs-identifier">DelegationCantApplyBlocks</span></a></a><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Pos.Delegation.Logic.html#DelegationError"><span class="hs-identifier hs-type">DelegationError</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-141"></a><span>    </span><a name="local-8214565720323798062"><span class="hs-identifier">toException</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cryptokamiExceptionToException</span><span>
</span><a name="line-142"></a><span>    </span><a name="local-8214565720323798061"><span class="hs-identifier">fromException</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cryptokamiExceptionFromException</span><span>
</span><a name="line-143"></a><span>    </span><a name="local-8214565720323798060"><span class="hs-identifier">displayException</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toString</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">pretty</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">B</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Delegation.Logic.html#DelegationError"><span class="hs-identifier hs-type">DelegationError</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-146"></a><span>    </span><a name="local-8214565720323844945"><span class="hs-identifier">build</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.html#DelegationCantApplyBlocks"><span class="hs-identifier hs-var">DelegationCantApplyBlocks</span></a><span> </span><a name="local-6989586621680330711"><a href="#local-6989586621680330711"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;can't apply in delegation module: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">stext</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680330711"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-150"></a><span class="hs-comment">-- Initialization</span><span>
</span><a name="line-151"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-- | Initializes delegation in-memory storage.</span><span>
</span><a name="line-154"></a><span class="hs-comment">--</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- * Sets `_dwEpochId` to epoch of tip.</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- * Loads `_dwThisEpochPosted` from database</span><span>
</span><a name="line-157"></a><span class="hs-identifier">initDelegation</span><span>
</span><a name="line-158"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621680330664"><a href="#local-6989586621680330664"><span class="hs-identifier">ssc</span></a></a><span> </span><a name="local-6989586621680330665"><a href="#local-6989586621680330665"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-159"></a><span>       </span><span class="hs-special">(</span><a href="Pos.Ssc.Class.Helpers.html#SscHelpersClass"><span class="hs-identifier hs-type">SscHelpersClass</span></a><span> </span><a href="#local-6989586621680330664"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadDB</span><span> </span><a href="#local-6989586621680330665"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#MonadDelegation"><span class="hs-identifier hs-type">MonadDelegation</span></a><span> </span><a href="#local-6989586621680330665"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621680330665"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><a name="initDelegation"><a href="Pos.Delegation.Logic.html#initDelegation"><span class="hs-identifier">initDelegation</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-162"></a><span>    </span><a name="local-6989586621680330681"><a href="#local-6989586621680330681"><span class="hs-identifier">tip</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.DB.DB.html#getTipBlockHeader"><span class="hs-identifier hs-var">DB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getTipBlockHeader</span></a><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621680330664"><span class="hs-identifier hs-type">ssc</span></a><span>
</span><a name="line-163"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680330682"><a href="#local-6989586621680330682"><span class="hs-identifier">tipEpoch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680330681"><span class="hs-identifier hs-var">tip</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">epochIndexL</span><span>
</span><a name="line-164"></a><span>    </span><a name="local-6989586621680330683"><a href="#local-6989586621680330683"><span class="hs-identifier">fromGenesisPsks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-165"></a><span>        </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">pskIssuerPk</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.html#getPSKsFromThisEpoch"><span class="hs-identifier hs-var">getPSKsFromThisEpoch</span></a><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621680330664"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621680330681"><span class="hs-identifier hs-var">tip</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>    </span><a href="Pos.Delegation.Logic.html#runDelegationStateAction"><span class="hs-identifier hs-var">runDelegationStateAction</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ether</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-167"></a><span>        </span><a href="Pos.Delegation.Class.html#dwEpochId"><span class="hs-identifier hs-var">dwEpochId</span></a><span> </span><span class="hs-operator hs-var">.=</span><span> </span><a href="#local-6989586621680330682"><span class="hs-identifier hs-var">tipEpoch</span></a><span>
</span><a name="line-168"></a><span>        </span><a href="Pos.Delegation.Class.html#dwThisEpochPosted"><span class="hs-identifier hs-var">dwThisEpochPosted</span></a><span> </span><span class="hs-operator hs-var">.=</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><a href="#local-6989586621680330683"><span class="hs-identifier hs-var">fromGenesisPsks</span></a><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- Heavyweight PSK</span><span>
</span><a name="line-172"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-comment">-- | Retrieves current mempool of heavyweight psks plus undo part.</span><span>
</span><a name="line-175"></a><span class="hs-identifier">getProxyMempool</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadDB</span><span> </span><a href="#local-6989586621680330663"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#MonadDelegation"><span class="hs-identifier hs-type">MonadDelegation</span></a><span> </span><a href="#local-6989586621680330663"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621680330663"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ProxySKHeavy</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ProxySKHeavy</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><a name="getProxyMempool"><a href="Pos.Delegation.Logic.html#getProxyMempool"><span class="hs-identifier">getProxyMempool</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-179"></a><span>    </span><a name="local-6989586621680330684"><a href="#local-6989586621680330684"><span class="hs-identifier">sks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Delegation.Logic.html#runDelegationStateAction"><span class="hs-identifier hs-var">runDelegationStateAction</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ether</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-180"></a><span>        </span><span class="hs-identifier hs-var">uses</span><span> </span><a href="Pos.Delegation.Class.html#dwProxySKPool"><span class="hs-identifier hs-var">dwProxySKPool</span></a><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">elems</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680330685"><a href="#local-6989586621680330685"><span class="hs-identifier">issuers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">pskIssuerPk</span><span> </span><a href="#local-6989586621680330684"><span class="hs-identifier hs-var">sks</span></a><span>
</span><a name="line-182"></a><span>    </span><a name="local-6989586621680330686"><a href="#local-6989586621680330686"><span class="hs-identifier">toRollback</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Pos.Delegation.DB.html#getPSKByIssuer"><span class="hs-identifier hs-var">GS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getPSKByIssuer</span></a><span> </span><a href="#local-6989586621680330685"><span class="hs-identifier hs-var">issuers</span></a><span>
</span><a name="line-183"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680330684"><span class="hs-identifier hs-var">sks</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680330686"><span class="hs-identifier hs-var">toRollback</span></a><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-identifier">clearProxyMemPool</span><span>
</span><a name="line-186"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadDB</span><span> </span><a href="#local-6989586621680330662"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#MonadDelegation"><span class="hs-identifier hs-type">MonadDelegation</span></a><span> </span><a href="#local-6989586621680330662"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621680330662"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><a name="clearProxyMemPool"><a href="Pos.Delegation.Logic.html#clearProxyMemPool"><span class="hs-identifier">clearProxyMemPool</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-189"></a><span>    </span><a name="local-6989586621680330689"><a href="#local-6989586621680330689"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Delegation.Class.html#askDelegationState"><span class="hs-identifier hs-var">askDelegationState</span></a><span>
</span><a name="line-190"></a><span>    </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">modifyTVar'</span><span> </span><a href="#local-6989586621680330689"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680330687"><span class="hs-identifier hs-var">resetData</span></a><span>
</span><a name="line-191"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621680330687"><a href="#local-6989586621680330687"><span class="hs-identifier">resetData</span></a></a><span> </span><a name="local-6989586621680330688"><a href="#local-6989586621680330688"><span class="hs-identifier">delegationWrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680330688"><span class="hs-identifier hs-var">delegationWrap</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">_dwProxySKPool</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span class="hs-special">}</span><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span class="hs-comment">-- | Datatypes representing a verdict of heavy PSK processing.</span><span>
</span><a name="line-195"></a><span class="hs-keyword">data</span><span> </span><a name="PskHeavyVerdict"><a href="Pos.Delegation.Logic.html#PskHeavyVerdict"><span class="hs-identifier">PskHeavyVerdict</span></a></a><span>
</span><a name="line-196"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="PHExists"><a href="Pos.Delegation.Logic.html#PHExists"><span class="hs-identifier">PHExists</span></a></a><span>       </span><span class="hs-comment">-- ^ If we have exactly the same cert in psk mempool</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="PHInvalid"><a href="Pos.Delegation.Logic.html#PHInvalid"><span class="hs-identifier">PHInvalid</span></a></a><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-comment">-- ^ Can't accept PSK though it's most probably user's error</span><span>
</span><a name="line-198"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="PHBroken"><a href="Pos.Delegation.Logic.html#PHBroken"><span class="hs-identifier">PHBroken</span></a></a><span>       </span><span class="hs-comment">-- ^ Broken (signature, most probably attack, we can ban for this)</span><span>
</span><a name="line-199"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="PHCached"><a href="Pos.Delegation.Logic.html#PHCached"><span class="hs-identifier">PHCached</span></a></a><span>       </span><span class="hs-comment">-- ^ Message is cached</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="PHIncoherent"><a href="Pos.Delegation.Logic.html#PHIncoherent"><span class="hs-identifier">PHIncoherent</span></a></a><span>   </span><span class="hs-comment">-- ^ Verdict can't be made at the moment (we're updating)</span><span>
</span><a name="line-201"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="PHAdded"><a href="Pos.Delegation.Logic.html#PHAdded"><span class="hs-identifier">PHAdded</span></a></a><span>        </span><span class="hs-comment">-- ^ Successfully processed/added to psk mempool</span><span>
</span><a name="line-202"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">-- | Processes heavyweight psk. Puts it into the mempool</span><span>
</span><a name="line-205"></a><span class="hs-comment">-- depending on issuer's stake, overrides if exists, checks</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- validity and cachemsg state.</span><span>
</span><a name="line-207"></a><span class="hs-identifier">processProxySKHeavy</span><span>
</span><a name="line-208"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621680330660"><a href="#local-6989586621680330660"><span class="hs-identifier">ssc</span></a></a><span> </span><a name="local-6989586621680330661"><a href="#local-6989586621680330661"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-209"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Ssc.Class.Helpers.html#SscHelpersClass"><span class="hs-identifier hs-type">SscHelpersClass</span></a><span> </span><a href="#local-6989586621680330660"><span class="hs-identifier hs-type">ssc</span></a><span>
</span><a name="line-210"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadDB</span><span> </span><a href="#local-6989586621680330661"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-211"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#MonadDelegation"><span class="hs-identifier hs-type">MonadDelegation</span></a><span> </span><a href="#local-6989586621680330661"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-212"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasContext</span><span> </span><span class="hs-identifier hs-type">LrcContext</span><span> </span><a href="#local-6989586621680330661"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-213"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">ProxySKHeavy</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680330661"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Pos.Delegation.Logic.html#PskHeavyVerdict"><span class="hs-identifier hs-type">PskHeavyVerdict</span></a><span>
</span><a name="line-215"></a><a name="processProxySKHeavy"><a href="Pos.Delegation.Logic.html#processProxySKHeavy"><span class="hs-identifier">processProxySKHeavy</span></a></a><span> </span><a name="local-6989586621680330696"><a href="#local-6989586621680330696"><span class="hs-identifier">psk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-216"></a><span>    </span><a name="local-6989586621680330697"><a href="#local-6989586621680330697"><span class="hs-identifier">curTime</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span>
</span><a name="line-217"></a><span>    </span><a name="local-6989586621680330698"><a href="#local-6989586621680330698"><span class="hs-identifier">headEpoch</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">view</span><span> </span><span class="hs-identifier hs-var">epochIndexL</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.DB.DB.html#getTipBlockHeader"><span class="hs-identifier hs-var">DB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getTipBlockHeader</span></a><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621680330660"><span class="hs-identifier hs-type">ssc</span></a><span>
</span><a name="line-218"></a><span>    </span><a name="local-6989586621680330699"><a href="#local-6989586621680330699"><span class="hs-identifier">richmen</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-219"></a><span>        </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-220"></a><span>        </span><a href="Pos.Context.Functions.html#lrcActionOnEpochReason"><span class="hs-identifier hs-var">lrcActionOnEpochReason</span></a><span>
</span><a name="line-221"></a><span>        </span><a href="#local-6989586621680330698"><span class="hs-identifier hs-var">headEpoch</span></a><span>
</span><a name="line-222"></a><span>        </span><span class="hs-string">&quot;Delegation.Logic#processProxySKHeavy: there are no richmen for current epoch&quot;</span><span>
</span><a name="line-223"></a><span>        </span><a href="Pos.Lrc.DB.Richmen.html#getRichmenDlg"><span class="hs-identifier hs-var">LrcDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getRichmenDlg</span></a><span>
</span><a name="line-224"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680330700"><a href="#local-6989586621680330700"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Delegation.Types.html#SendProxySKHeavy"><span class="hs-identifier hs-var">SendProxySKHeavy</span></a><span> </span><a href="#local-6989586621680330696"><span class="hs-identifier hs-var">psk</span></a><span>
</span><a name="line-225"></a><span>        </span><a name="local-6989586621680330701"><a href="#local-6989586621680330701"><span class="hs-identifier">consistent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">verifyProxySecretKey</span><span> </span><a href="#local-6989586621680330696"><span class="hs-identifier hs-var">psk</span></a><span>
</span><a name="line-226"></a><span>        </span><a name="local-6989586621680330702"><a href="#local-6989586621680330702"><span class="hs-identifier">issuer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pskIssuerPk</span><span> </span><a href="#local-6989586621680330696"><span class="hs-identifier hs-var">psk</span></a><span>
</span><a name="line-227"></a><span>        </span><a name="local-6989586621680330703"><a href="#local-6989586621680330703"><span class="hs-identifier">enoughStake</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addressHash</span><span> </span><a href="#local-6989586621680330702"><span class="hs-identifier hs-var">issuer</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680330699"><span class="hs-identifier hs-var">richmen</span></a><span>
</span><a name="line-228"></a><span>        </span><a name="local-6989586621680330704"><a href="#local-6989586621680330704"><span class="hs-identifier">omegaCorrect</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680330698"><span class="hs-identifier hs-var">headEpoch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">pskOmega</span><span> </span><a href="#local-6989586621680330696"><span class="hs-identifier hs-var">psk</span></a><span>
</span><a name="line-229"></a><span>    </span><a href="Pos.Delegation.Logic.html#runDelegationStateAction"><span class="hs-identifier hs-var">runDelegationStateAction</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ether</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-230"></a><span>        </span><a name="local-6989586621680330706"><a href="#local-6989586621680330706"><span class="hs-identifier">exists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">uses</span><span> </span><a href="Pos.Delegation.Class.html#dwProxySKPool"><span class="hs-identifier hs-var">dwProxySKPool</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680330705"><a href="#local-6989586621680330705"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621680330702"><span class="hs-identifier hs-var">issuer</span></a><span> </span><a href="#local-6989586621680330705"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680330696"><span class="hs-identifier hs-var">psk</span></a><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span>        </span><a name="local-6989586621680330707"><a href="#local-6989586621680330707"><span class="hs-identifier">cached</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span><span> </span><a href="#local-6989586621680330700"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">use</span><span> </span><a href="Pos.Delegation.Class.html#dwMessageCache"><span class="hs-identifier hs-var">dwMessageCache</span></a><span>
</span><a name="line-232"></a><span>        </span><a name="local-6989586621680330708"><a href="#local-6989586621680330708"><span class="hs-identifier">alreadyPosted</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">uses</span><span> </span><a href="Pos.Delegation.Class.html#dwThisEpochPosted"><span class="hs-identifier hs-var">dwThisEpochPosted</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span><span> </span><a href="#local-6989586621680330702"><span class="hs-identifier hs-var">issuer</span></a><span>
</span><a name="line-233"></a><span>        </span><a name="local-6989586621680330709"><a href="#local-6989586621680330709"><span class="hs-identifier">epochMatches</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680330698"><span class="hs-identifier hs-var">headEpoch</span></a><span> </span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">use</span><span> </span><a href="Pos.Delegation.Class.html#dwEpochId"><span class="hs-identifier hs-var">dwEpochId</span></a><span>
</span><a name="line-234"></a><span>        </span><a href="Pos.Delegation.Class.html#dwMessageCache"><span class="hs-identifier hs-var">dwMessageCache</span></a><span> </span><span class="hs-operator hs-var">%=</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-6989586621680330700"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621680330697"><span class="hs-identifier hs-var">curTime</span></a><span>
</span><a name="line-235"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680330710"><a href="#local-6989586621680330710"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680330701"><span class="hs-identifier hs-var">consistent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.html#PHBroken"><span class="hs-identifier hs-var">PHBroken</span></a><span>
</span><a name="line-236"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680330709"><span class="hs-identifier hs-var">epochMatches</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.html#PHIncoherent"><span class="hs-identifier hs-var">PHIncoherent</span></a><span>
</span><a name="line-237"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680330704"><span class="hs-identifier hs-var">omegaCorrect</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.html#PHInvalid"><span class="hs-identifier hs-var">PHInvalid</span></a><span> </span><span class="hs-string">&quot;PSK epoch is different from current&quot;</span><span>
</span><a name="line-238"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680330708"><span class="hs-identifier hs-var">alreadyPosted</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.html#PHInvalid"><span class="hs-identifier hs-var">PHInvalid</span></a><span> </span><span class="hs-string">&quot;issuer has already posted PSK this epoch&quot;</span><span>
</span><a name="line-239"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680330703"><span class="hs-identifier hs-var">enoughStake</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.html#PHInvalid"><span class="hs-identifier hs-var">PHInvalid</span></a><span> </span><span class="hs-string">&quot;issuer doesn't have enough stake&quot;</span><span>
</span><a name="line-240"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680330707"><span class="hs-identifier hs-var">cached</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.html#PHCached"><span class="hs-identifier hs-var">PHCached</span></a><span>
</span><a name="line-241"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680330706"><span class="hs-identifier hs-var">exists</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.html#PHExists"><span class="hs-identifier hs-var">PHExists</span></a><span>
</span><a name="line-242"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.html#PHAdded"><span class="hs-identifier hs-var">PHAdded</span></a><span>
</span><a name="line-243"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680330710"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Pos.Delegation.Logic.html#PHAdded"><span class="hs-identifier hs-var">PHAdded</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Delegation.Class.html#dwProxySKPool"><span class="hs-identifier hs-var">dwProxySKPool</span></a><span> </span><span class="hs-operator hs-var">%=</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-6989586621680330702"><span class="hs-identifier hs-var">issuer</span></a><span> </span><a href="#local-6989586621680330696"><span class="hs-identifier hs-var">psk</span></a><span>
</span><a name="line-244"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621680330710"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">-- state needed for 'delegationVerifyBlocks'</span><span>
</span><a name="line-247"></a><span class="hs-keyword">data</span><span> </span><a name="DelVerState"><a href="Pos.Delegation.Logic.html#DelVerState"><span class="hs-identifier">DelVerState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="DelVerState"><a href="Pos.Delegation.Logic.html#DelVerState"><span class="hs-identifier">DelVerState</span></a></a><span>
</span><a name="line-248"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="_dvCurEpoch"><a href="Pos.Delegation.Logic.html#_dvCurEpoch"><span class="hs-identifier">_dvCurEpoch</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HashSet</span><span> </span><span class="hs-identifier hs-type">PublicKey</span><span>
</span><a name="line-249"></a><span>      </span><span class="hs-comment">-- ^ Set of issuers that have already posted certificates this epoch</span><span>
</span><a name="line-250"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_dvPSKMapAdded"><a href="Pos.Delegation.Logic.html#_dvPSKMapAdded"><span class="hs-identifier">_dvPSKMapAdded</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HashMap</span><span> </span><span class="hs-identifier hs-type">PublicKey</span><span> </span><span class="hs-identifier hs-type">ProxySKHeavy</span><span>
</span><a name="line-251"></a><span>      </span><span class="hs-comment">-- ^ Psks added to database.</span><span>
</span><a name="line-252"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_dvPSKSetRemoved"><a href="Pos.Delegation.Logic.html#_dvPSKSetRemoved"><span class="hs-identifier">_dvPSKSetRemoved</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HashSet</span><span> </span><span class="hs-identifier hs-type">PublicKey</span><span>
</span><a name="line-253"></a><span>      </span><span class="hs-comment">-- ^ Psks removed from database.</span><span>
</span><a name="line-254"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-char">''DelVerState

-- | Verifies if blocks are correct relatively to the delegation logic
-- and returns a non-empty list of proxySKs needed for undoing
-- them. Predicate for correctness here is:
--
-- * Issuer can post only one cert per epoch
-- * For every new certificate issuer had enough stake at the
--   end of prev. epoch
--
-- It's assumed blocks are correct from 'Pos.Types.Block#verifyBlocks'
-- point of view.
delegationVerifyBlocks
    :: forall ssc m. (SscHelpersClass ssc, MonadDB m, HasContext LrcContext m)
    =&gt; OldestFirst NE (Block ssc)
    -&gt; m (Either Text (OldestFirst NE [ProxySKHeavy]))
delegationVerifyBlocks blocks = do
    -- TODO CSL-502 create snapshot
    tip &lt;- GS.getTip
    fromGenesisPsks &lt;- getPSKsFromThisEpoch @ssc tip
    let _dvCurEpoch = HS.fromList $ map pskIssuerPk fromGenesisPsks
        initState = DelVerState _dvCurEpoch HM.empty HS.empty
    richmen &lt;-
        HS.fromList . toList &lt;$&gt;
        lrcActionOnEpochReason
        headEpoch
        &quot;Delegation.Logic#delegationVerifyBlocks: there are no richmen for current epoch&quot;
        LrcDB.getRichmenDlg
    when (HS.size _dvCurEpoch /= length fromGenesisPsks) $
        throwM $ DBMalformed &quot;Multiple stakeholders have issued &amp; published psks this epoch&quot;
    evalStateT (runExceptT $ mapM (verifyBlock richmen) blocks) initState
  where
    headEpoch = blocks ^. _Wrapped . _neHead . epochIndexL
    withMapResolve issuer = do
        isAddedM &lt;- HM.lookup issuer &lt;$&gt; use dvPSKMapAdded
        isRemoved &lt;- HS.member issuer &lt;$&gt; use dvPSKSetRemoved
        if isRemoved
        then pure Nothing
        else maybe (GS.getPSKByIssuer issuer) (pure . Just) isAddedM
    withMapAdd psk = do
        let issuer = pskIssuerPk psk
        dvPSKMapAdded %= HM.insert issuer psk
        dvPSKSetRemoved %= HS.delete issuer
    withMapRemove issuer = do
        inAdded &lt;- HM.member issuer &lt;$&gt; use dvPSKMapAdded
        if inAdded
        then dvPSKMapAdded %= HM.delete issuer
        else dvPSKSetRemoved %= HS.insert issuer
    verifyBlock _ (Left _) = do
        dvCurEpoch .= HS.empty
        pure []
    verifyBlock richmen (Right blk) = do
        let proxySKs = view blockProxySKs blk
            issuers = map pskIssuerPk proxySKs
        when (any (not . (`HS.member` richmen) . addressHash) issuers) $
            throwE $ sformat (&quot;Block &quot;%build%&quot; contains psk issuers that &quot;%
                              &quot;don't have enough stake&quot;)
                             (headerHash blk)
        curEpoch &lt;- use dvCurEpoch
        when (any (`HS.member` curEpoch) issuers) $
            throwE $ sformat (&quot;Block &quot;%build%&quot; contains issuers that &quot;%
                              &quot;have already published psk this epoch&quot;)
                             (headerHash blk)
        -- we believe issuers list doesn't contain duplicates,
        -- checked in Types.Block#verifyBlocks
        dvCurEpoch %= HS.union (HS.fromList issuers)
        let toUpdate =
                filter (\ProxySecretKey{..} -&gt; pskIssuerPk /= pskDelegatePk) proxySKs
        toRollback &lt;- catMaybes &lt;$&gt; mapM withMapResolve issuers
        mapM_ withMapRemove issuers
        mapM_ withMapAdd toUpdate
        pure toRollback

-- | Applies a sequence of definitely valid blocks to memory state and
-- returns batchops. It works correctly only in case blocks don't
-- cross over epoch. So genesis block is either absent or the head.
delegationApplyBlocks
    :: forall ssc m. (DelegationWorkMode m)
    =&gt; OldestFirst NE (Block ssc) -&gt; m (NonEmpty SomeBatchOp)
delegationApplyBlocks blocks = do
    tip &lt;- GS.getTip
    let assumedTip = blocks ^. _Wrapped . _neHead . prevBlockL
    when (tip /= assumedTip) $ throwM $
        DelegationCantApplyBlocks $
        sformat
        (&quot;Oldest block is based on tip &quot;%shortHashF%&quot;, but our tip is &quot;%shortHashF)
        assumedTip tip
    getOldestFirst &lt;$&gt; mapM applyBlock blocks
  where
    applyBlock :: Block ssc -&gt; m SomeBatchOp
    applyBlock (Left block)      = do
        runDelegationStateAction $ ether $ do
            -- all possible psks candidates are now invalid because epoch changed
            dwProxySKPool .= HM.empty
            dwThisEpochPosted .= HS.empty
            dwEpochId .= (block ^. epochIndexL)
        pure (SomeBatchOp ([]::[GS.DelegationOp]))
    applyBlock (Right block) = do
        let proxySKs = view blockProxySKs block
            issuers = map pskIssuerPk proxySKs
            (toDelete,toReplace) =
                partition (\ProxySecretKey{..} -&gt; pskIssuerPk == pskDelegatePk)
                proxySKs
            batchOps = map (GS.DelPSK . pskIssuerPk) toDelete ++ map GS.AddPSK toReplace
        runDelegationStateAction $ ether $ do
            dwEpochId .= block ^. epochIndexL
            for_ issuers $ \i -&gt; do
                dwProxySKPool %= HM.delete i
                dwThisEpochPosted %= HS.insert i
        pure $ SomeBatchOp batchOps


-- | Rollbacks block list. Erases mempool of certificates. Better to
-- restore them after the rollback (see Txp#normalizeTxpLD). You can
-- rollback arbitrary number of blocks.
delegationRollbackBlocks
    :: forall ssc m.
       ( SscHelpersClass ssc
       , MonadDelegation m
       , MonadDB m
       , HasContext LrcContext m
       )
    =&gt; NewestFirst NE (Blund ssc) -&gt; m (NonEmpty SomeBatchOp)
delegationRollbackBlocks blunds = do
    tipBlockAfterRollback &lt;-
        maybe (throwM malformedLastParent) pure =&lt;&lt;
        DB.getBlock @ssc (blunds ^. _Wrapped . _neLast . _1 . prevBlockL)
    let epochAfterRollback = tipBlockAfterRollback ^. epochIndexL
    richmen &lt;-
        HS.fromList . toList &lt;$&gt;
        lrcActionOnEpochReason
        (tipBlockAfterRollback ^. epochIndexL)
        &quot;delegationRollbackBlocks: there are no richmen for last rollbacked block epoch&quot;
        LrcDB.getRichmenDlg
    fromGenesisIssuers &lt;-
        HS.fromList . map pskIssuerPk &lt;$&gt; getPSKsFromThisEpoch @ssc tipAfterRollbackHash
    runDelegationStateAction $ ether $ do
        dwProxySKPool %=
            (HM.filterWithKey $ \pk psk -&gt;
                 not (pk `HS.member` fromGenesisIssuers) &amp;&amp;
                 (addressHash pk) `HS.member` richmen &amp;&amp;
                 pskOmega psk == epochAfterRollback)
        dwThisEpochPosted .= fromGenesisIssuers
        dwEpochId .= tipBlockAfterRollback ^. epochIndexL
    pure $ getNewestFirst (map rollbackBlund blunds)
  where
    malformedLastParent = DBMalformed $
        &quot;delegationRollbackBlocks: parent of last rollbacked block is not in blocks db&quot;
    tipAfterRollbackHash = blunds ^. _Wrapped . _neLast . _1 . prevBlockL
    rollbackBlund :: Blund ssc -&gt; SomeBatchOp
    rollbackBlund (Left _, _) = SomeBatchOp ([]::[GS.DelegationOp])
    rollbackBlund (Right block, undo) =
        let proxySKs = view blockProxySKs block
            toReplace =
                map pskIssuerPk $
                filter (\ProxySecretKey{..} -&gt; pskIssuerPk /= pskDelegatePk)
                proxySKs
            toDeleteBatch = map GS.DelPSK toReplace
            toAddBatch = map GS.AddPSK $ undoPsk undo
        in SomeBatchOp $ toDeleteBatch ++ toAddBatch


----------------------------------------------------------------------------
-- Lightweight PSK propagation
----------------------------------------------------------------------------

-- | PSK check verdict. It can be unrelated (other key or spoiled, no
-- way to differ), exist in storage already or be cached.
data PskLightVerdict
    = PLUnrelated
    | PLInvalid
    | PLExists
    | PLCached
    | PLRemoved
    | PLAdded
    deriving (Show,Eq)

-- TODO CSL-687 Calls to DB are not synchronized for now, because storage is
-- append-only, so nothing bad should happen. But it may be a problem
-- later.
-- | Processes proxy secret key (understands do we need it,
-- adds/caches on decision, returns this decision).
processProxySKLight
    :: (MonadDelegation m, WithNodeContext ssc m, MonadDB m, MonadMask m)
    =&gt; ProxySKLight -&gt; m PskLightVerdict
processProxySKLight psk = do
    sk &lt;- npSecretKey . ncNodeParams &lt;$&gt; getNodeContext
    curTime &lt;- liftIO getCurrentTime
    miscLock &lt;- view DB.miscLock &lt;$&gt; DB.getNodeDBs
    psks &lt;- withReadLifted miscLock Misc.getProxySecretKeys
    res &lt;- runDelegationStateAction $ ether $ do
        let related = toPublic sk == pskDelegatePk psk
            exists = psk `elem` psks
            msg = SendProxySKLight psk
            valid = verifyProxySecretKey psk
            selfSigned = pskDelegatePk psk == pskIssuerPk psk
        cached &lt;- HM.member msg &lt;$&gt; use dwMessageCache
        dwMessageCache %= HM.insert msg curTime
        pure $ if | not valid -&gt; PLInvalid
                  | cached -&gt; PLCached
                  | exists -&gt; PLExists
                  | selfSigned -&gt; PLRemoved
                  | not related -&gt; PLUnrelated
                  | otherwise -&gt; PLAdded
    -- (2) We're writing to DB
    when (res == PLAdded) $ withWriteLifted miscLock $
        Misc.addProxySecretKey psk
    when (res == PLRemoved) $ withWriteLifted miscLock $
        Misc.removeProxySecretKey $ pskIssuerPk psk
    pure res

----------------------------------------------------------------------------
-- Lightweight PSK confirmation backpropagation
----------------------------------------------------------------------------

-- | Verdict of 'processConfirmProxySk' function
data ConfirmPskLightVerdict
    = CPValid   -- ^ Valid, saved
    | CPInvalid -- ^ Invalid, throw away
    | CPCached  -- ^ Already saved
    deriving (Show,Eq)

-- | Takes a lightweight psk, delegate proof of delivery. Checks if
-- it's valid or not. Caches message in any case.
processConfirmProxySk
    :: (MonadDelegation m, MonadIO m)
    =&gt; ProxySKLight -&gt; ProxySigLight ProxySKLight -&gt; m ConfirmPskLightVerdict
processConfirmProxySk psk proof = do
    curTime &lt;- liftIO getCurrentTime
    runDelegationStateAction $ ether $ do
        let valid = proxyVerify SignProxySK
                      (pdDelegatePk proof)
                      proof
                      (const True)
                      psk
        cached &lt;- HM.member psk &lt;$&gt; use dwConfirmationCache
        when valid $ dwConfirmationCache %= HM.insert psk curTime
        pure $ if | cached    -&gt; CPCached
                  | valid     -&gt; CPValid
                  | otherwise -&gt; CPInvalid

-- | Checks if we hold a confirmation for given PSK.
isProxySKConfirmed :: ProxySKLight -&gt; DelegationStateAction Bool
isProxySKConfirmed psk = ether $ HM.member psk &lt;$&gt; use dwConfirmationCache
</span></pre></body></html>